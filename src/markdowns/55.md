---
layout: post
title: Bitmapçš„è®¾è®¡å®ç°åŠå®æˆ˜åº”ç”¨
date: 2023-04-09
tags: ["CFC æŠ€æœ¯"]
---

å¤§å®¶ä¼°è®¡éƒ½çŸ¥é“ä»Šå¤©çš„ä¸»è§’Bitmapï¼ˆä½å›¾ï¼‰è¿™ä¸ªä¸œè¥¿ï¼Œä¹Ÿéƒ½çŸ¥é“å®ƒæ˜¯ä¸€ç§éå¸¸æœ‰è¶£ä¸”é¹…å¦¹å­å˜¤å¸¦ç‚¹å„¿"é»‘ç§‘æŠ€"çš„æ•°æ®ç»“æ„ï¼Œå®ƒèƒ½å¤Ÿç”¨éå¸¸éå¸¸ä½çš„å­˜å‚¨æˆæœ¬å­˜å‚¨æ•°æ®çš„çŠ¶æ€ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†ä»0åˆ°1å®ç°ä¸€ä¸ªBitmapï¼Œå¹¶åŸºäºRedisçš„Bitmapåœ¨å®é™…åº”ç”¨åœºæ™¯ä¸­å‘æŒ¥Bitmapçš„ä¼˜ç‚¹ã€‚

## å®ç°ä¸€ä¸ªBitmap

### åŸç†ä¸å®ç°æ€è·¯

æˆ‘ä»¬é¦–å…ˆæ¥ç®€å•çš„å†è¿‡ä¸€éä½å›¾çš„åŸç†ï¼ŒBitmapæ˜¯ä¸€ç§å°†æ¯ä¸€ä¸ªå­—èŠ‚ç”¨åˆ°æè‡´çš„æ•°æ®ç»“æ„ï¼Œä½å›¾çš„ä½¿ç”¨åœºæ™¯å®é™…ä¸Šå’Œå¸ƒå°”æ•°ç»„æ˜¯ç›¸åŒçš„ï¼Œéƒ½æ˜¯è¡¨ç¤ºæŸä¸ªç´¢å¼•ä»£è¡¨çš„æ•°æ®é0å³1çš„äºŒå…ƒå¯¹ç«‹å…³ç³»ï¼Œåªä¸è¿‡æ•°æ®åœ¨bitmapä¸­çš„å­˜å‚¨ä¼šæ›´åŠ ç´§å‡‘ï¼Œä½¿ç”¨bitä½æ¥ä½œä¸ºä¸‹æ ‡ç´¢å¼•ï¼Œä»¥0æˆ–1æ¥ä»£æ›¿boolçš„false or trueã€‚å½“éœ€è¦åœ¨boolæ•°ç»„ä¸­åˆ¤æ–­ä¸‹æ ‡1024çš„æ•°æ®æ˜¯å¦ä¸ºtrueæ—¶ï¼Œå°±ç­‰ä»·äºåœ¨bitmapä¸­çš„ç¬¬1024ä½æ˜¯å¦ä¸º1ã€‚boolæ•°ç»„åœ¨å¤§å¤šæ•°è¯­è¨€ä¸­æ¯ä¸ªboolå€¼çš„å¤§å°éƒ½æ˜¯1byteï¼ˆ8bitï¼‰è¿™ä¹ˆç®—ä¸‹æ¥ï¼Œbitmapå¯ä»¥çœå»8å€çš„å­˜å‚¨ç©ºé—´ã€‚

> åœ¨Javaä¸­ï¼Œå•ä¸ªboolå€¼å 4byteï¼Œè€Œboolæ•°ç»„çš„åº•å±‚å®ç°å®é™…ä¸ºbyteæ•°ç»„ï¼Œå³1byte

åœ¨ç»å¤§å¤šæ•°çš„ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œå¯ä¾›æˆ‘ä»¬ç›´æ¥æ“ä½œçš„æœ€å°å•ä½æ˜¯byteï¼Œåªæœ‰ä¸€ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯8ä¸ªbitï¼ˆè¿™ä¸å†…å­˜å¯»å€æ˜¯ä»¥byteä¸ºå•ä½æœ‰å…³ï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬è¦æƒ³æ“ä½œbitæ¥å®ç°bitmapï¼Œéœ€è¦é€šè¿‡ä½ç§»æ“ä½œæ¥å®Œæˆã€‚

    Bitmapå®ä¾‹ä¸åˆ›å»ºæ–¹æ³•
    // Bitmapçš„æ•°æ®åº•å±‚ç”±byte sliceç»„ç»‡
    type Bitmap []byte

    // é€šè¿‡æŒ‡å®šçš„bité•¿åº¦æ–°å»ºä¸€ä¸ªBitmapå®ä¾‹
    func MakeBitmapWithBitSize(nBits int) Bitmap {
        // è§„å®šä¸€ä¸ªæœ€å°é•¿åº¦
        if nBits < 64 {
            nBits = 64
        }
        // éœ€è¦ç¡®ä¿bité•¿åº¦ä¸º8çš„å€æ•°
        return MakeBitmapWithByteSize((nBits + 7) / 8)
    }

    // é€šè¿‡æŒ‡å®šçš„byteé•¿åº¦æ–°å»ºä¸€ä¸ªBitmapå®ä¾‹
    func MakeBitmapWithByteSize(nBytes int) Bitmap {
        return make([]byte, nBytes)
    }

    // æ³¨: posçš„èµ·å§‹ä½ç½®ä¸º0
    // å°†æŒ‡å®šposçš„bitè®¾ç½®ä¸º1
    func (b Bitmap) SetTrue(bitPos uint32) {
        b[bitPos/8] '= 1 << (bitPos % 8)
    }

    // å°†æŒ‡å®šposçš„bitè®¾ç½®ä¸º0
    func (b Bitmap) SetFalse(bitPos uint32) {
        b[bitPos/8] &= ^(1 << (bitPos % 8))
    }

    // åˆ¤æ–­æŒ‡å®šposçš„bitæ˜¯å¦ä¸º1
    func (b Bitmap) IsTrue(bitPos uint32) bool {
        return b[bitPos/8]&(1<<(bitPos%8)) != 0
    }

    // é‡ç½®Bitmap
    func (b Bitmap) Reset() {
        for i := range b {
            b[i] = 0
        }
    }

    // Bitmapæ‰€å­˜å‚¨çš„å­—èŠ‚æ•°
    func (b Bitmap) ByteSize(bitPos uint32) int {
        return len(b)
    }

    // Bitmapæ‰€å­˜å‚¨çš„ä½æ•°
    func (b Bitmap) BitSize(bitPos uint32) int {
        return len(b) * 8
    }

æ˜¯çš„ï¼Œæˆ‘ä»¬è¿™æ ·å°±å®ç°äº†ä¸€ä¸ªBitmapï¼Œæ˜¯ä¸æ˜¯ä¼šæ„Ÿè§‰ **å°±è¿™ï¼Ÿ** ç¡®å®ï¼ŒBitmapæœ¬èº«å°±æ˜¯ä¸€ä¸ªéå¸¸ç®€å•æœ´å®çš„æ•°æ®ç»“æ„ï¼Œç»™äººä¸€ç§å¤§é“è‡³ç®€çš„æ„Ÿè§‰ã€‚ æ‰€æœ‰çš„æ ¸å¿ƒæ“ä½œéƒ½é›†ä¸­ä»¥ä¸‹ä¸‰æ­¥å½“ä¸­ï¼Œæˆ‘ä»¬æ¥é€ä¸€æ‹†è§£æ“ä½œè¿‡ç¨‹

    // SetTrue
    b[bitPos/8] '= 1 << (bitPos % 8)
    // SetFalse
    b[bitPos/8] &= ^(1 << (bitPos % 8))
    // IsTrue
    b[bitPos/8] & (1 << (bitPos % 8)) != 0

### bi[bitPos/8] '= 1 << (bitPos % 8)

è¿™ä¸ªæ“ä½œå°†Bitmapçš„ bitPos ä½ç½®ä¸Šçš„bitä½è®¾ç½®ä¸º1ã€‚ æˆ‘ä»¬é€šè¿‡ç»“åˆä¾‹å­çš„æ–¹å¼é€æ­¥ç”¨ç™½è¯è§£æè¿™ä¸ªæ“ä½œï¼š

*   **ç°å‡è®¾æˆ‘éœ€è¦å°†`0110 0101`çš„ç¬¬2ä½é€šè¿‡bitmap.SetTrue(1)ç½®ä¸º1**

1.  **é¦–å…ˆ**ï¼ŒbitPos / 8 è®¡ç®—å‡ºéœ€è¦æ“ä½œçš„å­—èŠ‚ç´¢å¼•ï¼ˆå³ç¬¬å‡ ä¸ªå­—èŠ‚ï¼‰ã€‚å› ä¸ºä¸€ä¸ªå­—èŠ‚æœ‰8ä¸ªbitä½ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨é™¤æ³•è¿ç®—æ¥è®¡ç®—è¯¥ä½æ‰€åœ¨çš„é‚£ä¸ªå­—èŠ‚ã€‚åœ¨æ­¤ä¾‹ä¸­å°±æ˜¯åœ¨ä¸‹æ ‡ä¸º0çš„ç´¢å¼•ä¸Šçš„byteå¤„ã€‚
2.  **ç„¶å**ï¼ŒbitPos % 8 è®¡ç®—å‡ºè¯¥å­—èŠ‚ä¸­éœ€è¦æ“ä½œçš„ä½æ•°ã€‚ä½¿ç”¨å–æ¨¡è¿ç®—ï¼Œå¯ä»¥è®¡ç®—å‡ºè¯¥ä½åœ¨å­—èŠ‚ä¸­çš„åç§»é‡ã€‚åœ¨æ­¤ä¾‹ä¸­åç§»é‡ä¸º1
3.  **æ¥ä¸‹æ¥**ï¼Œæ‰§è¡Œ 1 << (bitPos % 8) æŒ‰ä½å·¦ç§»è¿ç®—ï¼Œå°† 1ï¼ˆå³0000 0001ï¼‰ å·¦ç§» bitPos % 8 ä½ï¼ˆå³ä½äºå­—èŠ‚ä¸­çš„åç§»é‡ï¼‰ã€‚åœ¨æ­¤ä¾‹ä¸­å°±æ˜¯å°† 0000 0001 å‘å·¦ç§»1ä½å¾—åˆ° 0000 0010
4.  **æœ€å**ï¼Œæ‰§è¡Œ b[bitPos/8] '= 1 << (bitPos % 8) æ“ä½œï¼Œæˆ‘ä»¬é‡‡ç”¨ä½æˆ–è¿ç®—çš„æ“ä½œ"'"è¿›è¡Œèµ‹å€¼ï¼ˆ0'0 = 0ã€0'1 = 1ã€1'1 = 1ï¼‰å°†è¯¥ä½è®¾ç½®ä¸º 1ã€‚åœ¨æ­¤ä¾‹ä¸­å°±æ˜¯è®¡ç®—0110 0101 ' 0000 0010 = 0111 æœ€ç»ˆå¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ç»“æœ `0110 0111`ã€‚

### b[bitPos/8] &= ^(1 << (bitPos % 8))

è¿™ä¸ªæ“ä½œå°†Bitmapçš„ bitPos ä½ç½®ä¸Šçš„bitä½è®¾ç½®ä¸º0ã€‚ æˆ‘ä»¬é€šè¿‡ç»“åˆä¾‹å­çš„æ–¹å¼é€æ­¥ç”¨ç™½è¯è§£æè¿™ä¸ªæ“ä½œï¼š

*   **ç°å‡è®¾æˆ‘éœ€è¦å°†`0110 0101`çš„ç¬¬6ä½é€šè¿‡bitmap.SetFalse(5)ç½®ä¸º0**

1.  **é¦–å…ˆ**ï¼ŒbitPos / 8 è®¡ç®—å‡ºéœ€è¦æ“ä½œçš„å­—èŠ‚ç´¢å¼•ï¼ˆå³ç¬¬å‡ ä¸ªå­—èŠ‚ï¼‰ã€‚å› ä¸ºä¸€ä¸ªå­—èŠ‚æœ‰8ä¸ªbitä½ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨é™¤æ³•è¿ç®—æ¥è®¡ç®—è¯¥ä½æ‰€åœ¨çš„é‚£ä¸ªå­—èŠ‚ã€‚åœ¨æ­¤ä¾‹ä¸­å°±æ˜¯åœ¨ä¸‹æ ‡ä¸º0çš„ç´¢å¼•ä¸Šçš„byteå¤„ã€‚
2.  **ç„¶å**ï¼ŒbitPos % 8 è®¡ç®—å‡ºè¯¥å­—èŠ‚ä¸­éœ€è¦æ“ä½œçš„ä½æ•°ã€‚ä½¿ç”¨å–æ¨¡è¿ç®—ï¼Œå¯ä»¥è®¡ç®—å‡ºè¯¥ä½åœ¨å­—èŠ‚ä¸­çš„åç§»é‡ã€‚åœ¨æ­¤ä¾‹ä¸­åç§»é‡ä¸º5
3.  **æ¥ä¸‹æ¥**ï¼Œæ‰§è¡Œ 1 << (bitPos % 8) æŒ‰ä½å·¦ç§»è¿ç®—ï¼Œå°† 1ï¼ˆå³0001ï¼‰ å·¦ç§» bitPos % 8 ä½ï¼ˆå³ä½äºå­—èŠ‚ä¸­çš„åç§»é‡ï¼‰ã€‚åœ¨æ­¤ä¾‹ä¸­å°±æ˜¯å°† 0000 0001 å‘å·¦ç§»5ä½å¾—åˆ° 0010 0000
4.  **æ¥ç€**ï¼Œåº”ç”¨æŒ‰ä½å–åè¿ç®—ç¬¦å°†æ©ç å–åï¼ˆåœ¨Goè¯­è¨€ä¸­ "^" ä½œä¸ºä¸€å…ƒè¿ç®—ç¬¦æ—¶è¡¨ç¤ºæŒ‰ä½å–åæ“ä½œï¼‰ï¼Œå¾—åˆ°ä¸€ä¸ªè¿™ä¸ªé™¤äº†æˆ‘ä»¬è¦åˆ é™¤çš„é‚£ä¸ªbitä½ä¹‹å¤–æ‰€æœ‰ä½éƒ½æ˜¯1çš„æ©ç ã€‚å†æ­¤ä¾‹ä¸­å°±æ˜¯ 1101 1111.
5.  **æœ€å**ï¼Œæ‰§è¡Œ b[bitPos/8] &= ^(1 << (bitPos % 8)) æ“ä½œï¼Œæˆ‘ä»¬é‡‡ç”¨ä½æˆ–è¿ç®—çš„æ“ä½œ"&"è¿›è¡Œèµ‹å€¼ï¼ˆ0'0 = 0ã€0'1 =0ã€1'1 = 1ï¼‰å°†è¯¥ä½è®¾ç½®ä¸º 0ã€‚åœ¨æ­¤ä¾‹ä¸­å°±æ˜¯è®¡ç®— 0110 0101 & 1101 1111 = 0111 æœ€ç»ˆå¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ç»“æœ `0100 0101`ã€‚

### b[bitPos/8 ] & (1 << (bitPos % 8)) != 0

è¿™ä¸ªæ“ä½œåˆ¤æ–­ bitmap çš„ bitPos ä½ç½®ä¸Šçš„äºŒè¿›åˆ¶ä½æ˜¯å¦ä¸º1ã€‚ æˆ‘ä»¬é€šè¿‡ç»“åˆä¾‹å­çš„æ–¹å¼é€æ­¥ç”¨ç™½è¯è§£æè¿™ä¸ªæ“ä½œï¼š

*   **ç°å‡è®¾æˆ‘éœ€è¦ä½¿ç”¨bitmap.IsTrue(6)åˆ¤æ–­`0110 0101`çš„ç¬¬7ä½æ˜¯å¦ä¸º1**

1.  **é¦–å…ˆ**ï¼ŒbitPos / 8 è®¡ç®—å‡ºéœ€è¦æ“ä½œçš„å­—èŠ‚ç´¢å¼•ï¼ˆå³ç¬¬å‡ ä¸ªå­—èŠ‚ï¼‰ã€‚å› ä¸ºä¸€ä¸ªå­—èŠ‚æœ‰8ä¸ªbitä½ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨é™¤æ³•è¿ç®—æ¥è®¡ç®—è¯¥ä½æ‰€åœ¨çš„é‚£ä¸ªå­—èŠ‚ã€‚åœ¨æ­¤ä¾‹ä¸­å°±æ˜¯åœ¨ä¸‹æ ‡ä¸º0çš„ç´¢å¼•ä¸Šçš„byteå¤„ã€‚
2.  **ç„¶å**ï¼ŒbitPos % 8 è®¡ç®—å‡ºè¯¥å­—èŠ‚ä¸­éœ€è¦æ“ä½œçš„ä½æ•°ã€‚ä½¿ç”¨å–æ¨¡è¿ç®—ï¼Œå¯ä»¥è®¡ç®—å‡ºè¯¥ä½åœ¨å­—èŠ‚ä¸­çš„åç§»é‡ã€‚åœ¨æ­¤ä¾‹ä¸­åç§»é‡ä¸º6
3.  **æ¥ä¸‹æ¥**ï¼Œæ‰§è¡Œ 1 << (bitPos % 8) æŒ‰ä½å·¦ç§»è¿ç®—ï¼Œå°† 1ï¼ˆå³0000 0001ï¼‰ å·¦ç§» bitPos % 8 ä½ï¼ˆå³ä½äºå­—èŠ‚ä¸­çš„åç§»é‡ï¼‰ã€‚åœ¨æ­¤ä¾‹ä¸­å°±æ˜¯å°† 0000 0001 å‘å·¦ç§»6ä½å¾—åˆ° 0100 0000ã€‚
4.  **æ¥ç€**ï¼Œæ‰§è¡Œ b[bitPos/8] & (1 << (bitPos % 8)) æ“ä½œï¼Œæˆ‘ä»¬é€šè¿‡ä¸è¿ç®—åªä¿ç•™bitmapä¸­çš„æŒ‡å®šå­—èŠ‚å…¶ä»–bitä½å‡ä¸º0ï¼Œå¦‚æœä¸ä¸º1çš„è¯ï¼Œé‚£ä¹ˆè¿™8ä¸ªbitå…¨éƒ¨éƒ½å½’é›¶ï¼Œå¦‚æœä¸º1ï¼Œåˆ™è¿™8ä¸ªbitç»„æˆçš„byteå¿…ä¸ç­‰äº0ã€‚åœ¨æ­¤ä¾‹ä¸­å°±æ˜¯è®¡ç®— 0110 0101 & 0100 0000 = 0100 0000
5.  **æœ€å**ï¼Œæ‰§è¡Œ != 0 æ“ä½œï¼Œå¦‚æœè¯¥ä½ä¸º1ï¼Œåˆ™è¿”å›trueï¼›å¦åˆ™è¿”å›falseã€‚

æ€ä¹ˆæ ·æ˜¯ä¸æ˜¯éå¸¸çš„æ¸…æ¸…çˆ½çˆ½~

æ—¢ç„¶é€ å®Œäº†è½®å­å’±ä»¬å°±å¼€å§‹å®æˆ˜å§~

## åˆ©ç”¨Redisçš„Bitmapå®ç°ç”¨æˆ·ç‚¹èµ

å˜¿å˜¿ï¼Œbitmapçš„å®æˆ˜æˆ‘åä¸ç”¨è‡ªå·±é€ çš„è½®å­ï¼Œå°±æ˜¯ç©å„¿~

> å…¶å®ä¸»è¦æ˜¯Redisä¸­çš„æ•°æ®ç»“æ„æ˜¯å¯ä»¥è·¨è¿›ç¨‹å…±äº«çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬åº”ç”¨çš„æ›´å¹¿æ³›äº›ï¼Œæˆ‘ä»¬é€ å¥½çš„è½®å­å°†åœ¨åé¢çš„å®æˆ˜æ–‡ç« ä¸­ä½¿ç”¨ï¼ˆç”¨æ¥é€ å¦ä¸€ä¸ªè½®å­XDï¼‰

åœ¨å¾ˆå¤šçš„ä¸šåŠ¡ä¸­æ¨¡å—ï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªç‚¹èµçš„åŠŸèƒ½ï¼Œç‚¹èµæ“ä½œå¯èƒ½ä¼šæ¯”è¾ƒé¢‘ç¹ï¼Œè€Œä¸”å› ä¸ºå¯èƒ½ä¼šæ¶‰åŠåˆ°èµ„æºçš„çƒ­åº¦å’Œæ¨èæŒ‡æ•°ï¼Œä¸”ç”¨æˆ·çš„ç›´æ¥æ„ŸçŸ¥å¾ˆå¼ºï¼Œæ‰€ä»¥ä¹Ÿç®—æ˜¯ä¸€ä¸ªç›¸å¯¹é‡è¦çš„åŠŸèƒ½ã€‚

ç‚¹èµåŠŸèƒ½çš„è®¾è®¡æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š

1.  è¦èƒ½å¤ŸåŠæ—¶åé¦ˆï¼Œè®©ç”¨æˆ·æœ‰æ‰€æ„ŸçŸ¥ï¼Œå¹¶ä¸”è¦å°½é‡é¿å…ç”¨æˆ·æ˜¾ç¤ºæ•°æ®çš„ä¸ä¸€è‡´
2.  è¦èƒ½å¤Ÿæ ‡è®°ç”¨æˆ·æ˜¯å¦å·²ç‚¹èµï¼Œé¿å…ç”¨æˆ·åˆ·èµæ“ä½œ
3.  ä¸€ä¸ªé¡µé¢åŠ è½½æ—¶å¯èƒ½ä¼šæœ‰å¤§é‡éœ€è¦ç»Ÿè®¡ç‚¹èµçš„èµ„æºï¼Œéœ€è¦å¯¹ç‚¹èµè¿›è¡Œç¼“å­˜å¤„ç†ï¼Œé¿å…å¤§é‡çš„ç£ç›˜io

ç»“åˆä»¥ä¸Šè®¾è®¡éœ€æ±‚ï¼Œæˆ‘å…ˆè¯´å‡ºæœ€ç»ˆå¯ä»¥é€‰æ‹©çš„æ–¹æ¡ˆï¼š

é‡‡ç”¨åŸºäºRedisçš„å¼‚æ­¥ç¼“å­˜å†™å…¥ç­–ç•¥ï¼Œä»¥èµ„æºç±»å‹çš„å‰ç¼€ä¸èµ„æºIDä½œä¸ºKeyï¼Œç»´æŠ¤ä¸€ä¸ªBitmapï¼Œä»¥**ç”¨æˆ·çš„è‡ªå¢ID**ä½œä¸ºBitmapä¸­çš„æ ‡è¯†ç´¢å¼•ï¼Œå®ç°ç”¨æˆ·çš„ç‚¹èµæ“ä½œçš„è®°å½•ã€‚åå°è¿è¡Œä¸€ä¸ªå®šæ—¶å®šæ—¶ä»»åŠ¡ï¼Œå®šæ—¶å°†Redisä¸­çš„æ•°æ®æ‰¹é‡åŒæ­¥åˆ°æ•°æ®åº“çš„æŒä¹…åŒ–å­˜å‚¨ä¸­ã€‚

è¿™æ ·è®¾è®¡æœ‰ä»¥ä¸‹çš„ç‰¹ç‚¹ï¼š

1.  ç”¨æˆ·è·å–ç‚¹èµæ•°ã€æ‰§è¡Œç‚¹èµæ“ä½œéƒ½æ˜¯ç›´æ¥å’ŒåŸºäºå†…å­˜çš„Redisæ‰“äº¤é“ï¼Œé€Ÿåº¦ç›¸å¯¹è¾ƒå¿«ã€‚
2.  ä½¿ç”¨Bitmapå­˜å‚¨ç”¨æˆ·ç‚¹èµè®°å½•ï¼Œå¯çœä¸‹å¤§é‡çš„å†…å­˜ç©ºé—´ã€‚
3.  é‡‡ç”¨å¼‚æ­¥ç¼“å­˜å†™å…¥ç­–ç•¥ï¼Œæœ¬è´¨ä¸Šæ˜¯**ä¾èµ–Redisä½œä¸ºç¨³å®šçš„å­˜å‚¨ä»‹è´¨**è€Œéç®€å•çš„ç¼“å­˜ï¼Œåªè¦Redisä¸å´©æºƒåœ¨å®¢æˆ·ç«¯å°±ä¸ä¼šå‘ç”Ÿä¸ä¸€è‡´çš„ç°è±¡ï¼ˆæ¯”å¦‚ç‚¹èµåç”¨æˆ·åˆ·æ–°ï¼Œå‘ç°ç‚¹èµæ¶ˆå¤±ï¼‰ã€‚

> å½“ç„¶ï¼Œæ¨¡å—çš„è®¾è®¡ä¸æŠ€æœ¯é€‰å‹æ˜¯éœ€è¦æ ¹æ®ä¸šåŠ¡æœ¬èº«çš„ç‰¹ç‚¹è€Œå®šçš„ï¼Œåœ¨å½“å‰çš„ä¸šåŠ¡è®¾è®¡ä¸­å°±æ˜¯é»˜è®¤Redisæ˜¯è¾ƒä¸ºå¯é çš„å­˜å‚¨ï¼ŒåŸºæœ¬ä¸ä¼šå‡ºç°Rediså´©æºƒçš„çŠ¶å†µã€‚

### ä»£ç ç¤ºä¾‹

ä»¥è¯„è®ºæ¨¡å—çš„ç‚¹èµæ“ä½œä¸ºä¾‹

ä¸€äº›constæšä¸¾å€¼

    type IsLike int
    const (
        UNLIKE IsLike = iota
        LIKE
    )

    const(
      // COMMENT:LIKE:commentID -> bitmap
      COMMENT_LIKE_REDISPREKEY = "COMMENT:LIKE:"
    )

æ ¸å¿ƒæ–¹æ³•

    // æ›´æ”¹ç‚¹èµçŠ¶æ€ï¼Œç”±ä¸Šæ¸¸ä¼ å…¥çš„isLikeåˆ¤æ–­æ˜¯ç‚¹èµæ“ä½œè¿˜æ˜¯å–æ¶ˆç‚¹èµæ“ä½œ
    func (c *CommentDomain) ConvertLikeState(commentId int64, uid int64, isLike IsLike) *errs.BError {
        ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
        defer cancel()
        key := COMMENT_LIKE_REDISPREKEY+strconv.FormatInt(commentId, 10)
        err := c.redis.SetBit(ctx, key, uid, int(isLike)).Error()
        if err != nil {
            zap.L().Error("updateLikeState redis SetBit ERROR", zap.Error(err))
            return errs.RedisError
        }
        return nil
    }

    // åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç‚¹èµï¼ˆå‰ç«¯éœ€è¦çŸ¥æ™“çš„çŠ¶æ€ï¼‰
    func (c *CommentDomain) HasLiked(commentId int64, uid int64) (bool, *errs.BError) {
        ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
        defer cancel()
        key := COMMENT_LIKE_REDISPREKEY+strconv.FormatInt(commentId, 10)
        bit, err := c.redis.GetBit(ctx, key, uid).Result()
        if err != nil {
            zap.L().Error("HasLiked redis GetBit ERROR", zap.Error(err))
            return false, errs.RedisError
        }
        return bit == 1, nil
    }

    // è·å–è¯„è®ºçš„ç‚¹èµæ•°
    func (c *CommentDomain) CountLikeNum(commentId int64) (int64, *errs.BError) {
        ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
        defer cancel()
        key := COMMENT_LIKE_REDISPREKEY+strconv.FormatInt(commentId, 10)
        count, err := c.redis.BitCount(ctx, key, &redis.BitCount{Start: 0, End: -1}).Result()
        if err != nil {
            zap.L().Error("CountLikeNum redis BitCount ERROR", zap.Error(err))
            return 0, errs.RedisError
        }
        return count, nil
    }

ç®€å•çš„æµ‹è¯•ç”¨ä¾‹

    var commentDomain = domain.NewCommentDomain()

    func TestLike(t *testing.T) {
        count, err := commentDomain.CountLikeNum(5)
        log.Printf("init comment %d Like Num %d \n", 5, count)

        err = commentDomain.ConvertLikeState(5, 1000, LIKE)
        count, err = commentDomain.CountLikeNum(5)
        log.Printf("comment %d Like Num %d  after %d like \n", 5, count, 1000)

        err = commentDomain.ConvertLikeState(5, 1001, LIKE)
        count, err = commentDomain.CountLikeNum(5)
        log.Printf("comment %d Like Num %d  after %d like \n", 5, count, 1000)

        err = commentDomain.ConvertLikeState(5, 1001, UNLIKE)
        count, err = commentDomain.CountLikeNum(5)
        log.Printf("comment %d Like Num %d  after %d unlike \n", 5, count, 1001)

        liked, err := commentDomain.HasLiked(5, 1001)
        count, err = commentDomain.CountLikeNum(5)
        log.Printf("%d hasLiked comment %d : %t \n", 1001, count, liked)

        liked, err = commentDomain.HasLiked(5, 1000)
        count, err = commentDomain.CountLikeNum(5)
        log.Printf("%d hasLiked comment %d : %t \n", 1000, count, liked)

        if err != nil {
            log.Fatal(err)
        }
    }

è¾“å‡ºç»“æœ

    === RUN   TestLike
    2023/04/08 16:52:33 init comment 5 Like Num 0 
    2023/04/08 16:52:33 comment 5 Like Num 1  after 1000 like 
    2023/04/08 16:52:33 comment 5 Like Num 2  after 1000 like 
    2023/04/08 16:52:33 comment 5 Like Num 1  after 1001 unlike 
    2023/04/08 16:52:33 1001 hasLiked comment 1 : false 
    2023/04/08 16:52:33 1000 hasLiked comment 1 : true 
    --- PASS: TestLike (0.02s)
    PASS

è¿™æ ·ï¼Œä¸€ä¸ªæœ€åŸºæœ¬çš„è¯„è®ºç‚¹èµæ¨¡å—å°±åšå¥½äº†ï¼Œå½“ç„¶ï¼Œè¿™æ˜¯å°†å°è£…å¥½çš„æ¨¡å—æ‹†å‡ºæ¥æ”¾åœ¨è¿™é‡Œçš„ç¤ºä¾‹ä»£ç ï¼Œåœ¨å®é™…åº”ç”¨ä¸­åº”è¯¥éµå¾ªé¡¹ç›®çš„æ¨¡å—è¿›è¡Œå°è£…

### Extra

åœ¨è°ƒç ”å…¶ä»–ç½‘ç«™çš„apiè®¾è®¡çš„æ—¶å€™ï¼Œå‘ç°äº†ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„ç‚¹ã€‚CSDNåœ¨ç‚¹èµæ¨¡å—çš„è®¾è®¡ä¸Šï¼Œç‚¹èµä¸å–æ¶ˆç‚¹èµçš„å®¢æˆ·ç«¯è¯·æ±‚**å®Œå…¨ä¸€æ ·**ï¼

æ— è®ºæ˜¯è¯·æ±‚URLã€è¯·æ±‚æ–¹æ³•ã€è¡¨å•æ•°æ®å…¨éƒ¨éƒ½ä¸€æ ·ï¼

![æˆªå›¾](da6cd9b4459447f5fa33a663f10d7d55.png)

![æˆªå›¾](433cb8d7b8a7f274465c9338c5cef8b2.png)

åœ¨è¿”å›ç›¸åº”çš„æ—¶å€™ï¼Œæ•°æ®æ‰ä¼šæœ‰æ‰€ä¸åŒ

![æˆªå›¾](3040d9343b4d18eefc6d4ee8c114399a.png)

![æˆªå›¾](696d458c963cc150f365f9f745c1d46d.png)

è¿™æ˜¯ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„ç‚¹ï¼Œå¦‚æœå‰ç«¯ä¸ä¼ çŠ¶æ€çš„è¯ï¼Œåç«¯è¯¥å¦‚ä½•åˆ¤æ–­æ­¤æ“ä½œæ˜¯å–æ¶ˆç‚¹èµè¿˜æ˜¯ç‚¹èµæ“ä½œå‘¢ï¼Ÿ

æ—¢ç„¶å‰ç«¯æ²¡æœ‰æ ‡æ˜ï¼Œé‚£å°±åªèƒ½åç«¯å…ˆæŸ¥å†æ”¹äº†ï¼Œä½†æ˜¯è¿™æ— ç–‘æ˜¯æ¯”è¾ƒåƒèµ„æºçš„è¡Œä¸ºã€‚å‡è®¾csdnçš„åå°ä¹Ÿæ˜¯ç”¨Redisæ¥å­˜å‚¨ç‚¹èµæ ‡è¯†ï¼Œé‚£ä¹ˆä¹Ÿéœ€è¦æŸ¥ä¸¤æ¬¡Redisï¼Œå¤šä¸€æ¬¡ç½‘ç»œé€šä¿¡çš„å¼€é”€ï¼Œæˆ‘èƒ½æƒ³åˆ°çš„ç¨å¾®åˆç†ä¸€ç‚¹çš„æ“ä½œé€»è¾‘æ˜¯é…åˆä½¿ç”¨luaè„šæœ¬ï¼Œåœ¨Redisä¸­æ‰§è¡Œluaè„šæœ¬è¿›è¡Œåˆ†æ”¯åˆ¤æ–­è¿›è¡ŒCompare And Swapçš„åŸå­æ“ä½œï¼Œä»£ç å®ä¾‹å¦‚ä¸‹

    func (c *CommentDomain) ConvertLikeStateCAS(commentId int64, uid int64) (int64, bool, *errs.BError) {
        ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
        defer cancel()
        // luaè„šæœ¬
        script := `
            local key = KEYS[1]
            local userId = ARGV[1]
            local isLiked = redis.call("GETBIT", key, userId)
            if isLiked == 1 then
                redis.call("SETBIT", key, userId, 0)
                local isLiked = 0
            else
                redis.call("SETBIT", key, userId, 1)
                local isLiked = 1
            end
            local likeCount = redis.call("BITCOUNT", key)
            return {likeCount, isLiked}
        `
        key := COMMENT_LIKE_REDISPREKEY + strconv.FormatInt(commentId, 10)
        result, err := c.redis.Eval(ctx, script, []string{key}, uid)
        resArr := result.([]interface{})
        likeCount := resArr[0].(int64)
        hassLiked := resArr[1].(int64)
        if err != nil {
            zap.L().Error("ConvertLikeStateCAS redis Eval ERROR", zap.Error(err))
            return 0, false, errs.RedisError
        }
        return likeCount, hassLiked == 0, nil
    }

ç®€å•çš„æµ‹è¯•ç”¨ä¾‹

    func TestEval(t *testing.T) {
        // 1000 1001 1002 ç‚¹èµ 1002å–æ¶ˆèµ
        num, like, bError := commentDomain.ConvertLikeStateCAS(6, 1000)
        log.Println("after 0 like status: ", like, " likeNum: ", num)

        num, like, bError = commentDomain.ConvertLikeStateCAS(6, 1001)
        log.Println("after 1 like status: ", like, " likeNum: ", num)

        num, like, bError = commentDomain.ConvertLikeStateCAS(6, 1002)
        log.Println("after 2 like status: ", like, " likeNum: ", num)

        num, like, bError = commentDomain.ConvertLikeStateCAS(6, 1003)
        log.Println("after 3 like status: ", like, " likeNum: ", num)

        num, like, bError = commentDomain.ConvertLikeStateCAS(6, 1001)
        log.Println("after 1 unlike status: ", like, " likeNum: ", num)

        for i := 1000; i < 1004; i++ {
            hasLiked, _ := commentDomain.HasLiked(6, int64(i))
            log.Println("member", i, "hasliked ", hasLiked)
        }
        if bError != nil {
            log.Fatal(bError)
        }
        log.Println("after likeNum: ", num)
    }

ç®€å•çš„æµ‹è¯•ç”¨ä¾‹

    func TestEval(t *testing.T) {
        // 1000 1001 1002 ç‚¹èµ 1002å–æ¶ˆèµ
        num, like, bError := commentDomain.ConvertLikeStateCAS(6, 1000)
        log.Println("after 1000 like status: ", like, " likeNum: ", num)
        num, like, bError = commentDomain.ConvertLikeStateCAS(6, 1001)
        log.Println("after 1001 like status: ", like, " likeNum: ", num)
        num, like, bError = commentDomain.ConvertLikeStateCAS(6, 1002)
        log.Println("after 1002 like status: ", like, " likeNum: ", num)
        num, like, bError = commentDomain.ConvertLikeStateCAS(6, 1003)
        log.Println("after 1003 like status: ", like, " likeNum: ", num)
        num, like, bError = commentDomain.ConvertLikeStateCAS(6, 1001)
        log.Println("after 1001 unlike status: ", like, " likeNum: ", num)

        for i := 1000; i < 1004; i++ {
            hasLiked, _ := commentDomain.HasLiked(6, int64(i))
            log.Println("member", i, "hasliked ", hasLiked)
        }
        if bError != nil {
            log.Fatal(bError)
        }
        log.Println("after likeNum: ", num)
    }

è¾“å‡ºç»“æœ

    === RUN   TestEval
    2023/04/08 19:34:29 after 1000 like status:  true  likeNum:  1
    2023/04/08 19:34:29 after 1001 like status:  true  likeNum:  2
    2023/04/08 19:34:29 after 1002 like status:  true  likeNum:  3
    2023/04/08 19:34:29 after 1003 like status:  true  likeNum:  4
    2023/04/08 19:34:29 after 1001 unlike status:  false  likeNum:  3
    2023/04/08 19:34:29 member 1000 hasliked  true
    2023/04/08 19:34:29 member 1001 hasliked  false
    2023/04/08 19:34:29 member 1002 hasliked  true
    2023/04/08 19:34:29 member 1003 hasliked  true
    2023/04/08 19:34:29 after likeNum:  3
    --- PASS: TestEval (0.03s)
    PASS

è¿™æ ·ä¸€æ¥ï¼Œå°±å¯ä»¥å®ç°å’Œcsdnçš„ç‚¹èµä¸€æ ·çš„æ•ˆæœäº†ï¼ˆè™½ç„¶è‡³ä»Šæˆ‘ä¹Ÿä¸çŸ¥é“è¿™æ ·è®¾è®¡çš„ä¼˜ç‚¹åœ¨å“ªé‡Œï¼Œä½†è¿˜æ˜¯æŒºæœ‰æ„æ€çš„

> è¯´èµ·csdnï¼Œæ¨èä¸€ä¸ªæ²¹çŒ´è„šæœ¬ ï¼Œå¯ä»¥é¿å…ç™»å½•æ‰èƒ½å¤åˆ¶ä¹‹ç±»çš„è®¨åŒçš„é™åˆ¶ï¼ˆè™½ç„¶æ”¹å˜ä¸äº†csdné‡Œé¢çš„å†…å®¹å¤šæ•°éƒ½æ˜¯åˆæ°´åˆçƒ‚çš„ç°çŠ¶ï¼Œèƒ½åœ¨å›½å†…çš„æ˜é‡‘çŸ¥ä¹æ‰¾åˆ°çš„ä¸œè¥¿è¿˜æ˜¯åˆ«å»çœ‹csdnäº†å§
>   [ğŸ”¥æŒç»­æ›´æ–°ğŸ”¥ CSDNå¹¿å‘Šå®Œå…¨è¿‡æ»¤ã€äººæ€§åŒ–è„šæœ¬ä¼˜åŒ–ï¼šğŸ†• ä¸ç”¨å†ç™»å½•äº†ï¼è®©ä½ ä½“éªŒä»¤äººæƒŠå–œçš„å´­æ–°CSDN (greasyfork.org)](https://greasyfork.org/zh-CN/scripts/378351-æŒç»­æ›´æ–°-csdnå¹¿å‘Šå®Œå…¨è¿‡æ»¤-äººæ€§åŒ–è„šæœ¬ä¼˜åŒ–-ä¸ç”¨å†ç™»å½•äº†-è®©ä½ ä½“éªŒä»¤äººæƒŠå–œçš„å´­æ–°csdn)

## Tipsï¼š

ä»¥ä¸Šçš„è®¾è®¡æ˜¯åŸºäºç”¨æˆ·idä¸ºè‡ªå¢idçš„åŸºç¡€ä¸Šè€Œå®ç°çš„ï¼Œå¦‚æœåœ¨ä½ çš„ç³»ç»Ÿä¸­ä½¿ç”¨çš„æ˜¯UUIDæˆ–è€…é›ªèŠ±ç®—æ³•ç”Ÿæˆçš„IDè¯·å‹¿ç›´æ¥ä½¿ç”¨bitmapï¼Œè¿™ä¼šå¯¼è‡´bitmapçˆ†æ‰~
UUIDæ˜¯128ä½çš„å­—ç¬¦ä¸²ï¼Œä¸”å®Œå…¨æ²¡æœ‰é¡ºåºï¼Œå¹¶ä¸é€‚åˆä½¿ç”¨bitmapå­˜å‚¨
é›ªèŠ±ç®—æ³•ç”ŸæˆIDæ˜¯64ä½çš„æ•´å‹ï¼Œä¹Ÿä¸èƒ½ç›´æ¥ä½¿ç”¨bitmapå› ä¸º **æ ¹ æœ¬ å­˜ ä¸ ä¸‹**ï¼

    2^64 bit = 18446744073709551616 bit
    = 2305843009213696 MB
    = 2251799813685248 GB
    = 2202670619951340.672 TB

ï¼ˆä¸è¿‡é›ªèŠ±ç®—æ³•æ˜¯æœ‰åºçš„ï¼Œæ‰€ä»¥ç†è®ºä¸Šå¯ä»¥ä»æœ€å°idå¼€å§‹è®°å½•ï¼‰
æ‰€ä»¥ä½ ä¹Ÿçœ‹åˆ°äº†bitmapçš„ä¸€ä¸ªç¼ºé™·ï¼Œå®ƒæœ€é€‚åˆå­˜å‚¨çš„æ˜¯è¿ç»­çš„æ•°æ®ï¼Œå®ƒæ‰€å ç”¨çš„ç©ºé—´ä¹Ÿæ˜¯æ ¹æ®æœ€å¤§çš„æ•°è€Œå®šçš„ï¼Œå¦‚æœç³»ç»Ÿä¸­çš„æ•°æ®åˆ†å¸ƒçš„éå¸¸å¹¿ï¼Œå¯èƒ½bitmapå°±å¹¶ä¸æ˜¯å¾ˆåˆé€‚ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå¯èƒ½é‡‡ç”¨hashçš„æ–¹å¼æ˜¯æ›´åˆç†çš„ã€‚
æ­¤å¤–ï¼ŒRedisä¸­è¿˜æä¾›äº†ä¸€ç§å«åšHyperLogLogçš„æ•°æ®ç»“æ„ç”¨äºåŸºæ•°ç»Ÿè®¡ï¼Œå®ƒè¦æ¯”bitmapè¿˜è¦æ›´"é»‘ç§‘æŠ€"ï¼Œä¸è¿‡ç›¸åº”çš„ï¼Œå®ƒä¹Ÿæ˜¯ä»¥éƒ¨åˆ†å‡†ç¡®æ€§çš„ä»£ä»·æ¥æ¢å–çš„ï¼Œå¯ä»¥ç”¨åœ¨å¯¹å‡†ç¡®æ€§æ²¡æœ‰é‚£ä¹ˆé«˜çš„ç»Ÿè®¡æ•°å€¼ä¸Šï¼Œæ¯”å¦‚"æµè§ˆé‡"ï¼Œä¹‹åæœ‰æ—¶é—´çš„è¯ä¹Ÿè®¸ä¼šå†™ä¸€ç‰‡æ–‡ç« æ¥ä»‹ç»ä¸€ä¸‹HLLåœ¨å®è·µä¸­çš„åº”ç”¨å§XD